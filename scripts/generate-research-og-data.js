/**
 * Generate Research Post OG Data for Cloudflare Middleware
 *
 * This script reads ghost-posts.json and generates a lookup file
 * that the Cloudflare middleware uses to inject proper OG meta tags
 * for research post pages when social media crawlers request them.
 */

import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

const POSTS_FILE = path.join(__dirname, '../src/data/ghost-posts.json');
const OUTPUT_FILE = path.join(__dirname, '../functions/research-og-data.js');

// Dynamic OG image generator URL
const OG_IMAGE_BASE = 'https://perception-og-image.fernandonikolic.workers.dev/api/og-image';

function truncateText(text, maxLength) {
  if (!text || text.length <= maxLength) return text || '';
  return text.substring(0, maxLength - 3) + '...';
}

function cleanText(str) {
  if (!str) return '';
  // Just clean up whitespace - JSON.stringify handles escaping
  return str
    .replace(/\n/g, ' ')
    .replace(/\r/g, '')
    .replace(/\s+/g, ' ')
    .trim();
}

function generateOgImageUrl(title, description) {
  const params = new URLSearchParams({
    title: truncateText(title, 100),
    description: truncateText(description, 150),
    theme: 'dark'
  });
  return `${OG_IMAGE_BASE}?${params.toString()}`;
}

function main() {
  console.log('Generating research OG data for Cloudflare middleware...');

  // Read posts data
  if (!fs.existsSync(POSTS_FILE)) {
    console.error('Error: ghost-posts.json not found. Run npm run ghost:fetch first.');
    process.exit(1);
  }

  const data = JSON.parse(fs.readFileSync(POSTS_FILE, 'utf8'));
  const posts = data.posts || [];

  console.log(`Processing ${posts.length} research posts...`);

  // Build lookup object
  const ogData = {};

  for (const post of posts) {
    if (!post.slug) continue;

    // Get the best available values with fallbacks
    const title = post.og_title || post.meta_title || post.title || 'Research';
    const description = post.og_description || post.meta_description || post.custom_excerpt || post.excerpt || '';

    // Priority: feature_image (main post image) > og_image > generated fallback
    const ogImage = post.feature_image || post.og_image || generateOgImageUrl(title, description);

    ogData[post.slug] = {
      title: cleanText(truncateText(title, 70)),
      description: cleanText(truncateText(description, 160)),
      image: ogImage,
      publishedAt: post.published_at || null,
      updatedAt: post.updated_at || null,
      author: post.primary_author?.name || 'Perception',
      tags: post.tags?.map(t => t.name).slice(0, 5) || []
    };
  }

  // Generate the JS file
  const output = `/**
 * Research Post OG Data
 * Auto-generated by scripts/generate-research-og-data.js
 * DO NOT EDIT MANUALLY
 *
 * Generated: ${new Date().toISOString()}
 * Total posts: ${Object.keys(ogData).length}
 */

export const RESEARCH_OG_DATA = ${JSON.stringify(ogData, null, 2)};

export const DEFAULT_RESEARCH_IMAGE = 'https://perception.to/social-images/pages/bitcoin-media-research.png';
`;

  fs.writeFileSync(OUTPUT_FILE, output, 'utf8');
  console.log(`Generated ${OUTPUT_FILE} with ${Object.keys(ogData).length} posts`);
}

main();
